---
title: "Seurat_to_SFE"
subtitle: "NOTE: supports Visium, Vizgen and Xenium"
author: "Alik Huseynov"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup
```{r setup}
# set R options, paths, object params, names, functions, etc..
message("Setting options, paths and object params..")
Sys.setenv(LANG = "en")

# To get metadata df from SFE or Seurat object
getMeta <- 
  function(object = NULL) {
    if (class(object) == "Seurat") {
      #is(object, "Seurat")
      # return Seurat metadata
      return(methods::slot(object, name = "meta.data"))
      } else {
        return(colData(object) |> 
                 methods::slot(name = "listData") |> 
                 as.data.frame.list())
      }
    }

# set root dir
dir_root <- "~/Desktop/github_projects/SpatialFeatureExperiment/"
dir_extdata <- file.path(dir_root, "inst/extdata/")

# set BPPARAM
BPPARAM <- BiocParallel::MulticoreParam(3,
                                        tasks = 2L,
                                        force.GC = FALSE,
                                        progressbar = TRUE)
```

## Load R packages
```{r load_libs}
suppressPackageStartupMessages({
    library(ggplot2)
    #library(SingleCellExperiment)
    library(scater)
    library(scuttle)
    library(Seurat)
    #library(SeuratData)
    #library(dplyr)
    library(magrittr)
    #library(scales)    
    #library(spatstat)
    library(patchwork)
    #library(Matrix)
    #library(SpatialExperiment)
    library(Voyager)   
    library(SpatialFeatureExperiment)
    library(SFEData)
    #library(terra)
    library(BiocParallel)
    #library(sf)    
    })
```

## Load Seurat v5 objects - 1 sample
Note, these object were generated a priori, object names with (eg `*_vis` for Visium) correspond to specific spatial tech
```{r}
obj_vz <- readRDS(file.path(dir_extdata, "seu_vz_toy.rds"))
obj_vz
obj_xen <- readRDS(file.path(dir_extdata, "seu_xen_toy.rds"))
obj_xen
obj_vis <- readRDS(file.path(dir_extdata, "seu_vis_toy.rds"))
obj_vis
```

## Convert Seurat -> SFE - Visium (toy data)
```{r}
showMethods("toSpatialFeatureExperiment")
# real Visium data
sfe_conv_vis <-
  toSpatialFeatureExperiment(x = obj_vis, 
                             image_scalefactors = "lowres",
                             unit = "micron",
                             BPPARAM = BPPARAM)
sfe_conv_vis
getMeta(sfe_conv_vis) %>% str
```

## Plot converted SFE Visium (toy data)
```{r}
plotSpatialFeature(sfe_conv_vis, exprs_values = "counts",
                   features = rownames(sfe_conv_vis)[1], 
                   size = 1, colGeometryName = "spotPoly",
                   dark = TRUE,
                   show_axes = TRUE,
                   #sample_id = "",
                   scattermore = FALSE # will plot only centroids!
                  )
```

## Load Visium Seurat object (real data)
Visium data is taken from `SeuratData` (ie `stxBrain.SeuratData`), subsetted to keep first 50 genes, and added to `./inst/extdata/`. Note, the spot diameter was added manually as `80`, since older Seurat version had a bug when adding spatial infos to `scale.factors`, `$spot` was too small and same as `$hires`
```{r}
obj_vis_2 <- readRDS(file.path(dir_root, "inst/extdata/seu_anterior1_visium.rds"))
obj_vis_2
# plot it
SpatialFeaturePlot(obj_vis_2, features = rownames(obj_vis_2)[1])
```

## Convert Seurat -> SFE - Visium (real data)
```{r}
# real Visium data
sfe_conv_vis_2 <-
  toSpatialFeatureExperiment(x = obj_vis_2, 
                             image_scalefactors = "lowres",
                             unit = "micron",
                             BPPARAM = BPPARAM)
sfe_conv_vis_2
getMeta(sfe_conv_vis_2) %>% str
```

## Plot converted Seurat to SFE - Visium
```{r}
plotSpatialFeature(sfe_conv_vis_2, exprs_values = "counts",
                   features = rownames(sfe_conv_vis_2)[1], 
                   #size = 1, colGeometryName = "spotPoly",
                   dark = TRUE,
                   show_axes = TRUE,
                   #sample_id = "",
                   scattermore = FALSE # will plot only centroids!
                  )
```

## Convert Seurat -> SFE - Xenium
```{r}
# slim down Xenium obj to keep only 1 Assay
if (!exists("obj_xen_slim"))
  obj_xen_slim <- DietSeurat(obj_xen, assays = "Xenium")
#real data subset
sfe_conv_xen <-
  toSpatialFeatureExperiment(x = obj_xen_slim,
                             add_molecules = TRUE,
                             flip = "geometry",
                             unit = "micron",
                             BPPARAM = BPPARAM
                             )
sfe_conv_xen
getMeta(sfe_conv_xen) %>% str
getMeta(obj_xen) %>% str
```

## Plot converted Seurat to SFE - Xenium
```{r}
#options(repr.plot.height = 5, repr.plot.width = 10)
plotSpatialFeature(sfe_conv_xen, exprs_values = "counts",
                   features = rownames(sfe_conv_xen)[1],
                   size = 1, colGeometryName = "cellSeg", 
                   dark = TRUE,
                   #sample_id = "",
                   scattermore = FALSE # will plot only centroids!
                  )
```

## Convert Seurat -> SFE - Vizgen
```{r}
# real data
sfe_conv_vz <-
  toSpatialFeatureExperiment(x = obj_vz,
                             add_molecules = TRUE,
                             
                             # TODO: test flip = "image" or "none" ----
                             flip = "geometry",
                             unit = "micron",
                             BPPARAM = BPPARAM)
sfe_conv_vz
getMeta(sfe_conv_vz) %>% str
getMeta(obj_vz) %>% str
```

## Plot converted Seurat to SFE - Vizgen
```{r}
#options(repr.plot.height = 5, repr.plot.width = 10)
plotSpatialFeature(sfe_conv_vz, exprs_values = "counts",
                   features = rownames(sfe_conv_vz)[1],
                   size = 1, colGeometryName = "cellSeg", 
                   dark = TRUE,
                   #sample_id = "",
                   scattermore = FALSE # will plot only centroids!
                  )
```

## Test when Seurat object has > 1 Assay - Xenium
```{r}
sfe_conv_xen2 <-
  toSpatialFeatureExperiment(x = obj_xen,
                             add_molecules = TRUE,
                             flip = "geometry",
                             unit = "micron",
                             BPPARAM = BPPARAM
                             )
sfe_conv_xen2
getMeta(sfe_conv_xen2) %>% str
getMeta(obj_xen) %>% str
```
## Plot converted Seurat to SFE with several `altExp` - Xenium
```{r}
plotSpatialFeature(sfe_conv_xen2, exprs_values = "counts",
                   features = rownames(sfe_conv_xen2)[1],
                   size = 1, colGeometryName = "cellSeg", 
                   dark = TRUE,
                   #sample_id = "",
                   scattermore = FALSE # will plot only centroids!
                  )
```

## Plot one of the `altExp` - Xenium
```{r}
plotSpatialFeature(altExp(sfe_conv_xen2, 1), exprs_values = "counts",
                   features = rownames(altExp(sfe_conv_xen2, 1))[1],
                   size = 1, colGeometryName = "centroids", 
                   dark = TRUE,
                   #sample_id = "",
                   scattermore = FALSE # will plot only centroids!
)
```

## TODO: Test when Seurat object has > 1 Assay - Vizgen + SCT Assays
```{r}





```


## Load Seurat objects with several samples/FOVs
```{r}




```

## TODO: Test when multiple samples/FOVs are present in Seurat object
NOTE, the function will automatically check how many FOVs Seurat object has and combine those samples in a single SFE object
```{r}



```

## TODO quick analysis using Voyager
```{r}
# 



```








